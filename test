-- NEW: SKU Ã— App Team (time optional as a filter; defaults to ALL TIME)
WITH sku_team_base AS (
  SELECT
    u.sku_name                           AS sku_name,   -- or COALESCE(u.billing_origin_product, u.sku_name)
    u.custom_tags['DPE_APP_ID']          AS app_team,   -- or element_at(u.custom_tags, :param_single_tag_key)
    u.time_key                           AS period,     -- for filtering only
    u.usage_usd
  FROM list_priced_usd_with_time_key u   -- already includes discounts in usage_usd
)

SELECT
  sku_name,
  app_team,
  SUM(usage_usd) AS cost_usd
FROM sku_team_base
WHERE app_team IS NOT NULL
  -- dashboard filters (optional). If left empty, ALL values are included.
  AND ({{sku_filter}}      IS NULL OR sku_name IN ({{sku_filter}}))
  AND ({{app_team_filter}} IS NULL OR app_team IN ({{app_team_filter}}))
  AND ({{period_start}}    IS NULL OR period >= {{period_start}})
  AND ({{period_end}}      IS NULL OR period <  {{period_end}})
GROUP BY sku_name, app_team
ORDER BY sku_name, app_team;

