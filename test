WITH base AS (
  SELECT
    custom_tags['DPE_APP_ID'] AS dpe_app_id,
    sku_name,
    usage_usd
  FROM list_priced_usd_with_time_key
  WHERE custom_tags['DPE_APP_ID'] IS NOT NULL
),
agg AS (
  SELECT dpe_app_id, sku_name, SUM(usage_usd) AS usd
  FROM base
  GROUP BY 1,2
)
SELECT
  dpe_app_id,

  /* Individual SKU columns */
  COALESCE(`ENTERPRISE_ALL_PURPOSE_COMPUTE`,0)            AS all_purpose_usd,
  COALESCE(`ENTERPRISE_ALL_PURPOSE_COMPUTE (PHOTON)`,0)   AS all_purpose_photon_usd,
  COALESCE(`ENTERPRISE_JOBS_COMPUTE`,0)                   AS jobs_usd,
  COALESCE(`ENTERPRISE_JOBS_COMPUTE (PHOTON)`,0)          AS jobs_photon_usd,
  COALESCE(`ENTERPRISE_SQL_PRO_COMPUTE`,0)                AS sql_usd,
  COALESCE(`ENTERPRISE_SQL_PRO_COMPUTE US EAST (PHOTON)`,0) AS sql_photon_usd,
  COALESCE(`ENTERPRISE_DLT_CORE_COMPUTE`,0)               AS dlt_core_usd,
  COALESCE(`ENTERPRISE_DLT_ADVANCED_COMPUTE`,0)           AS dlt_advanced_usd,
  COALESCE(`ENTERPRISE_DLT_ADVANCED_COMPUTE (PHOTON)`,0)  AS dlt_advanced_photon_usd,

  /* Total spend across all SKUs */
  COALESCE(`ENTERPRISE_ALL_PURPOSE_COMPUTE`,0) +
  COALESCE(`ENTERPRISE_ALL_PURPOSE_COMPUTE (PHOTON)`,0) +
  COALESCE(`ENTERPRISE_JOBS_COMPUTE`,0) +
  COALESCE(`ENTERPRISE_JOBS_COMPUTE (PHOTON)`,0) +
  COALESCE(`ENTERPRISE_SQL_PRO_COMPUTE`,0) +
  COALESCE(`ENTERPRISE_SQL_PRO_COMPUTE US EAST (PHOTON)`,0) +
  COALESCE(`ENTERPRISE_DLT_CORE_COMPUTE`,0) +
  COALESCE(`ENTERPRISE_DLT_ADVANCED_COMPUTE`,0) +
  COALESCE(`ENTERPRISE_DLT_ADVANCED_COMPUTE (PHOTON)`,0) AS total_usd

FROM agg
PIVOT (
  SUM(usd) FOR sku_name IN (
    'ENTERPRISE_ALL_PURPOSE_COMPUTE',
    'ENTERPRISE_ALL_PURPOSE_COMPUTE (PHOTON)',
    'ENTERPRISE_JOBS_COMPUTE',
    'ENTERPRISE_JOBS_COMPUTE (PHOTON)',
    'ENTERPRISE_SQL_PRO_COMPUTE',
    'ENTERPRISE_SQL_PRO_COMPUTE US EAST (PHOTON)',
    'ENTERPRISE_DLT_CORE_COMPUTE',
    'ENTERPRISE_DLT_ADVANCED_COMPUTE',
    'ENTERPRISE_DLT_ADVANCED_COMPUTE (PHOTON)'
  )
)
ORDER BY total_usd DESC;

