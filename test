WITH prices AS (
  SELECT
    sku_name,
    usage_unit,
    pricing.default                                 AS unit_price_usd,
    price_start_time,
    COALESCE(price_end_time, date_add(current_date, 1)) AS price_end_time
  FROM system.billing.list_prices
  WHERE currency_code = 'USD'
),

usage_priced AS (
  SELECT
    u.sku_name,
    u.custom_tags['DPE_APP_ID']                 AS dpe_id,
    DATE_TRUNC('MONTH', u.usage_date)           AS usage_month,
    u.usage_quantity,
    p.unit_price_usd,
    -- Cost = usage qty Ã— unit price
    (u.usage_quantity * p.unit_price_usd)       AS usage_usd
  FROM system.billing.usage u
  LEFT JOIN prices p
    ON u.sku_name        = p.sku_name
   AND u.usage_unit      = p.usage_unit
   AND u.usage_end_time BETWEEN p.price_start_time AND p.price_end_time
  WHERE u.custom_tags['DPE_APP_ID'] IS NOT NULL
    AND u.usage_date >= DATE('2024-06-01')   -- start date
    AND u.usage_date <= DATE('2025-07-31')   -- end date
)

SELECT
  dpe_id,
  sku_name,
  usage_month,
  ROUND(SUM(usage_usd), 2) AS total_spend_usd
FROM usage_priced
GROUP BY dpe_id, sku_name, usage_month
ORDER BY total_spend_usd DESC;
