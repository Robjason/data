-- A) Do we have usage rows in the window?
SELECT COUNT(*) AS n_rows
FROM system.billing.usage
WHERE CAST(usage_date AS DATE) >= :param_start_date
  AND CAST(usage_date AS DATE) <  :param_end_date;

-- B) What tag keys exist on THIS table?
SELECT k, COUNT(*) AS n
FROM (
  SELECT explode(map_keys(custom_tags)) AS k
  FROM system.billing.usage
  WHERE CAST(usage_date AS DATE) >= :param_start_date
    AND CAST(usage_date AS DATE) <  :param_end_date
) t
GROUP BY k
ORDER BY n DESC
LIMIT 50;
